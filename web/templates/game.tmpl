<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Jogo da Velha - {{.RoomCode}}</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/game.css">
</head>

<body>
    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <div class="container">
        <h1>Ultimate Jogo da Velha</h1>
        <div id="status" class="status">Conectando...</div>

        <div class="game-container">
            <div class="outer-board" id="board">

            </div>
        </div>

        <div id="message" class="message">Código da Sala: {{.RoomCode}}</div>
    </div>

    <script>
        const roomCode = "{{.RoomCode}}";
        const nickname = "{{.Nickname}}";
        const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
        const wsUrl = `${wsScheme}://${window.location.host}/ws/${roomCode}?nickname=${encodeURIComponent(nickname)}`;

        let socket = new WebSocket(wsUrl);
        let myPlayerSymbol = ""; // "X" or "O"
        let isMyTurn = false;
        let playerXName = "Jogador X";
        let playerOName = "Jogador O";

        let gameState = {
            boards: [],
            outer_board: [],
            next_board: -1
        };

        const statusDiv = document.getElementById("status");
        const boardDiv = document.getElementById("board");


        function initBoard() {
            boardDiv.innerHTML = "";
            for (let i = 0; i < 9; i++) {
                const outerCell = document.createElement("div");
                outerCell.className = "outer-cell";
                outerCell.dataset.outerIndex = i;

                const innerBoard = document.createElement("div");
                innerBoard.className = "inner-board";

                for (let j = 0; j < 9; j++) {
                    const innerCell = document.createElement("div");
                    innerCell.className = "inner-cell";
                    innerCell.dataset.outerIndex = i;
                    innerCell.dataset.innerIndex = j;
                    innerCell.addEventListener("click", onCellClick);
                    innerBoard.appendChild(innerCell);
                }

                outerCell.appendChild(innerBoard);
                boardDiv.appendChild(outerCell);
            }
        }

        socket.onopen = () => {
            statusDiv.textContent = "Aguardando oponente...";
        };

        socket.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            if (msg.type === "init") {
                myPlayerSymbol = msg.player; // "X" or "O"
                // Waiting for state to know names? Assuming names come in state updates.
                statusDiv.textContent = `Aguardando início... (Você é ${myPlayerSymbol})`;
            } else if (msg.type === "state") {
                if (msg.playerXName) playerXName = msg.playerXName;
                if (msg.playerOName) playerOName = msg.playerOName;
                updateGame(msg.state);
            }
        };

        socket.onclose = () => {
            statusDiv.textContent = "Desconectado.";
        };

        function getPlayerName(symbol) {
            if (symbol === "X") return playerXName;
            if (symbol === "O") return playerOName;
            return symbol;
        }

        function updateGame(state) {
            gameState = state;
            renderBoard();

            if (state.is_game_over) {
                if (state.winner === "Draw") {
                    statusDiv.textContent = "Empate!";
                } else {
                    const winnerName = getPlayerName(state.winner);
                    const loserSymbol = state.winner === "X" ? "O" : "X";
                    const loserName = getPlayerName(loserSymbol);
                    statusDiv.textContent = `${winnerName} derrotou ${loserName}`;
                }
                statusDiv.style.color = state.winner === myPlayerSymbol ? "var(--primary-color)" : "var(--text-color)";
                isMyTurn = false;
                return;
            }

            const currentTurnName = getPlayerName(state.turn);
            isMyTurn = (myPlayerSymbol === state.turn);

            if (isMyTurn) {
                statusDiv.textContent = `Sua vez! (${currentTurnName})`;
                statusDiv.style.color = "var(--primary-color)";
            } else {
                statusDiv.textContent = `Vez de ${currentTurnName}`;
                statusDiv.style.color = "var(--text-color)";
            }
        }

        function renderBoard() {
            const outerCells = document.querySelectorAll(".outer-cell");

            outerCells.forEach((outerCell, i) => {

                const outerStatus = gameState.outer_board[i];
                const innerBoardDiv = outerCell.querySelector(".inner-board");


                const existingOverlay = outerCell.querySelector(".winner-overlay");
                if (existingOverlay) existingOverlay.remove();

                if (outerStatus !== "") {

                    const overlay = document.createElement("div");
                    overlay.className = `winner-overlay ${outerStatus.toLowerCase()}`;
                    overlay.textContent = outerStatus === "Draw" ? "-" : outerStatus;
                    outerCell.appendChild(overlay);
                }


                const isTarget = (gameState.next_board === -1 || gameState.next_board === i) && outerStatus === "";

                if (isTarget && !gameState.is_game_over) {
                    outerCell.classList.add("active");
                } else {
                    outerCell.classList.remove("active");
                }


                const innerCells = outerCell.querySelectorAll(".inner-cell");
                innerCells.forEach((cell, j) => {
                    const val = gameState.boards[i] ? gameState.boards[i][j] : "";
                    cell.textContent = val;
                    cell.className = "inner-cell";
                    if (val === "X") cell.classList.add("x");
                    if (val === "O") cell.classList.add("o");
                });
            });
        }

        function onCellClick(e) {
            if (!myPlayerSymbol || !isMyTurn) return;

            const cell = e.target;
            const outerIndex = parseInt(cell.dataset.outerIndex);
            const innerIndex = parseInt(cell.dataset.innerIndex);


            if (gameState.outer_board[outerIndex] !== "") return;
            if (gameState.boards[outerIndex][innerIndex] !== "") return;

            if (gameState.next_board !== -1 && gameState.next_board !== outerIndex) return;

            socket.send(JSON.stringify({
                type: "move",
                outerIndex: outerIndex,
                innerIndex: innerIndex
            }));
        }

        initBoard();
    </script>
</body>

</html>